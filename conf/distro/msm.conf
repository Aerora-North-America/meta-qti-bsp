#############################################################################
#@TYPE: Distribution
#@NAME: MSM
#@DESCRIPTION: MSM Linux Distribution (eglibc based)
#@MAINTAINER: Frank Earl <fearl@codeaurora.org>
#@COMMENT: This distribution configuration defines a tiny OE Linux  
#@COMMENT: distribution. The matching buildable image target (9615-cdp-image)
#@COMMENT: basically consists of: libc, busybox, udev, sysv init, and a few
#@COMMENT: init scripts for running up the system.
#############################################################################

#############################################################################
# DISTRO CONFIGURATION
#############################################################################
DISTRO_NAME = "msm"
DISTRO_VERSION = "${SRCDATE}"
VIRTUAL-RUNTIME_dev_manager ?= "busybox-mdev"

#############################################################################
# DISTRO FEATURE SELECTION
#############################################################################
MICRO_GOLD = "ld-is-gold"
MICRO_GOLD_mips = ""
MICRO_GOLD_msm8960 = ""
MICRO_GOLD_msm8974 = ""
DISTRO_FEATURES += "eabi ipv6 ipv4 largefile thumb-interwork xattr ${MICRO_GOLD} ${DISTRO_FEATURES_LIBC}"

#############################################################################
# LIBRARY NAMES
#############################################################################
# Use Debian naming scheme for library (.so) files
INHERIT += "debian recipe_sanity"

#############################################################################
# PACKAGING & FEEDS
#############################################################################
# Select packaging system
PREFERRED_PKG_FORMAT = "ipk"
IPKG_VARIANT = "opkg"
PREFERRED_VERSION_dpkg = "1.15.8.11"

FULL_OPTIMIZATION = "-O2 -fexpensive-optimizations -frename-registers -fomit-frame-pointer"

require conf/distro/include/sane-feed-${PREFERRED_PKG_FORMAT}.inc

#############################################################################
# IMAGES
#############################################################################
# Name generated images
LIBC = "eglibc"

IMAGE_NAME = "${DISTRO_NAME}-${IMAGE_BASENAME}-${LIBC}-\
${PREFERRED_PKG_FORMAT}-${DISTRO_VERSION}-${MACHINE}"

CACHE ?= "${TMPDIR}/cache/${LIBC}/${MACHINE}"
DEPLOY_DIR ?= "${TMPDIR}/deploy/${LIBC}"
DEPLOY_DIR_IMAGE = "${DEPLOY_DIR}/images/${MACHINE}"

IMAGE_FEATURES = "read-only-rootfs debug-tweaks"

#############################################################################
# LINUX KERNEL SELECTION
#############################################################################
KERNEL = "kernel26"
MACHINE_KERNEL_VERSION ?= "2.6"

#############################################################################
# TOOLCHAIN
#############################################################################
TCLIBC ?= "eglibc"
PREFERRED_VERSION_eglibc            = "2.13"
PREFERRED_ARM_INSTRUCTION_SET ?= "thumb"
require conf/distro/include/arm-thumb.inc

#############################################################################
# Ensure MACHINE_CLASS is in OVERRIDES
#############################################################################
MACHINE_CLASS ?= ""
MACHINE_OVERRIDES += "${MACHINE_CLASS}"

#############################################################################
# NLS
#############################################################################
USE_NLS = "no"
USE_NLS_glib-2.0 = "yes"
USE_NLS_glib-2.0-native = "yes"
USE_NLS_gcc-cross = "no"

# Disable binary locale generation
ENABLE_BINARY_LOCALE_GENERATION = "0"

# Don't install useless symlinks to libraries
PACKAGE_SNAP_LIB_SYMLINKS = "1"

#Allow library symlinks to exist alongside soname files
#for packages that don't create proper symlinks
PACKAGE_SNAP_LIB_SYMLINKS_pn-adreno200 = "0"
PACKAGE_SNAP_LIB_SYMLINKS_pn-geofence = "0"
PACKAGE_SNAP_LIB_SYMLINKS_pn-mm-core-oss = "0"
PACKAGE_SNAP_LIB_SYMLINKS_pn-mm-video-oss = "0"
PACKAGE_SNAP_LIB_SYMLINKS_pn-mm-core-prop = "0"
PACKAGE_SNAP_LIB_SYMLINKS_pn-mm-video-prop = "0"
PACKAGE_SNAP_LIB_SYMLINKS_pn-mm-camera = "0"
PACKAGE_SNAP_LIB_SYMLINKS_pn-mm-camera-lib = "0"
PACKAGE_SNAP_LIB_SYMLINKS_pn-mm-still = "0"
PACKAGE_SNAP_LIB_SYMLINKS_pn-camera-hal = "0"
PACKAGE_SNAP_LIB_SYMLINKS_pn-sudo = "0"
PACKAGE_SNAP_LIB_SYMLINKS_pn-securemsm-noship = "0"
PACKAGE_SNAP_LIB_SYMLINKS_pn-libtbm-msm = "0"
PACKAGE_SNAP_LIB_SYMLINKS_pn-perf-libs = "0"

# Don't install ldconfig and associated gubbins
USE_LDCONFIG = "0"
LDCONFIGDEPEND = ""

# Disable online package management
ONLINE_PACKAGE_MANAGEMENT = "none"

DISTRO_BLUETOOTH_MANAGER = "bluez4"

COMMERCIAL_LICENSE_DEPENDEES = ""

# Add the yaffs2 imaging commands to the filesystem support for Bitbake as
# OE-Core doesn't support them directly...
IMAGE_CMD_yaffs2 = "mkyaffs2image ${EXTRA_IMAGECMD} ${IMAGE_ROOTFS} ${DEPLOY_DIR_IMAGE}/${IMAGE_NAME}.rootfs.yaffs2; chmod 644 ${DEPLOY_DIR_IMAGE}/${IMAGE_NAME}.rootfs.yaffs2"

# fastboot imaging commands
IMAGE_DEPENDS_fastboot = "mkbootimg-native virtual/kernel"
IMAGE_CMD_fastboot = "${STAGING_BINDIR_NATIVE}/mkbootimg --kernel ${STAGING_DIR_TARGET}/kernel/arch/arm/boot/Image --ramdisk /dev/null --ramdisk_offset $(awk --non-decimal-data '/ _end/ {end="0x" $1} /_stext/ {beg="0x" $1} END {size1=end-beg+4096; size=and(size1,compl(4095)); printf("%#x",size)}' ${STAGING_DIR_TARGET}/boot/System.map-${MACHINE_KERNEL_VERSION}) --cmdline 'root=${MACHINE_ROOTDEV} rw init=/sbin/init --verbose loglevel=7 rootwait console=${MACHINE_CONSOLE} no_console_suspend=1 androidboot.hardware=qcom log_buf_len=262144' --base ${MACHINE_KERNEL_BASE} ${EXTRA_IMAGECMD} --pagesize ${MACHINE_FLASH_PAGE_SIZE} --output ${DEPLOY_DIR_IMAGE}/${IMAGE_NAME}.rootfs.fastboot"

PREFERRED_VERSION_busybox-static ?= "1.18.5"

#############################################################################
# X11
#############################################################################
PREFERRED_PROVIDER_virtual/libx11 = "libx11"
PREFERRED_PROVIDER_libxcb = "libxcb"
