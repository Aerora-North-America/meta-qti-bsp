#@TYPE: Machine
#@NAME: TRUSTEDVM
#@DESCRIPTION: Machine configuration for QTI MTP with TRUSTEDVM

BASEMACHINE ?= "trustedvm"
require conf/machine/include/basemachine.inc

DEFAULTTUNE ?= "aarch64"
include conf/machine/include/arm/arch-armv8a.inc

PREFERRED_PROVIDER_virtual/kernel = "linux-dummy"
PREFERRED_VERSION_linux-msm ?= "5.15"
PREFERRED_VERSION_linux-msm-headers ?= "5.15"

LLVM_VERSION = "8.0"

PAGE_SIZE ?= '4096'

EXTRA_IMAGECMD ?= "-N 2048"

KERNEL_IMAGETYPE = "Image"
KERNEL_CMD_PARAMS = ""
KERNEL_VARIANT = ""
KERNEL_VARIANT_qti-distro-base-debug = "debug_"
SERIAL_CONSOLE = "115200 hvc0"

MACHINE_USES_KERNEL_PREBUILTS = "True"
KERNEL_PREBUILT_PATH ?= "${WORKSPACE}/kernel-5.10/out/*_tuivm-${KERNEL_VARIANT}defconfig/dist"

# filesystem configurations to be applied on image.
MACHINE_FSCONFIG_CONF = "trustedvm-fsconfig.conf"
MACHINE_SUPPORTS_USB = "False"
MACHINE_SUPPORTS_ANDROID_PROPERTIES = "False"
MACHINE_SUPPORTS_DISPLAY = "False"
MACHINE_SUPPORTS_SECUREMSM = "False"
MACHINE_MNT_POINTS = ""

# Formats of root filesystem images.
IMAGE_FSTYPES += "ext4"
IMAGE_INIT_MANAGER = "systemd"

SYSTEMIMAGE_TARGET = "system.img"
VMUSERDATAIMAGE_TARGET = "vm-userdata.img"
VMIMAGE_TARGET = "vm-bootsys.img"
DTB_TARGET = "trustedvm.dtb"
KERNEL_OFFSET = "0xF3C00000"
DTB_OFFSET = "0xF5C00000"
RAMDISK_OFFSET = "0xF5D00000"
# Ramdisk size is 8 MB
RAMDISK_SIZE = "8388608"

SYSTEM_SIZE_EXT4 ?= "150000000"
USERDATA_SIZE_EXT4 ?= "25000000"
VM_SIZE_EXT4 ?= "270000000"

MACHINE_FEATURES_append = " dm-verity-initramfs qti-vm"
