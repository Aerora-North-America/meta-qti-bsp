From 31c80a69e6398602821c06cd7e34becb4cd6c169 Mon Sep 17 00:00:00 2001
From: Tyler Wear <twear@codeaurora.org>
Date: Thu, 15 Aug 2013 16:08:02 -0700
Subject: [PATCH 1/1] port-desc

---
 commonrdr.h         |   14 ++++++++++----
 netfilter/iptcrdr.c |    7 ++++++-
 upnpredirect.c      |    3 +++
 3 files changed, 19 insertions(+), 5 deletions(-)
 mode change 100644 => 100755 commonrdr.h
 mode change 100644 => 100755 netfilter/iptcrdr.c
 mode change 100644 => 100755 upnpredirect.c

diff --git a/commonrdr.h b/commonrdr.h
old mode 100644
new mode 100755
index 5000458..c100f4e
--- a/commonrdr.h
+++ b/commonrdr.h
@@ -24,8 +24,11 @@ get_redirect_rule(const char * ifname, unsigned short eport, int proto,
                   char * iaddr, int iaddrlen, unsigned short * iport,
                   char * desc, int desclen,
                   char * rhost, int rhostlen,
-                  unsigned int * timestamp,
-                  u_int64_t * packets, u_int64_t * bytes);
+                  unsigned int * timestamp
+#ifndef QCMAP
+                  ,u_int64_t * packets, u_int64_t * bytes
+#endif
+                  );
 
 int
 get_redirect_rule_by_index(int index,
@@ -33,8 +36,11 @@ get_redirect_rule_by_index(int index,
                            char * iaddr, int iaddrlen, unsigned short * iport,
                            int * proto, char * desc, int desclen,
                            char * rhost, int rhostlen,
-                           unsigned int * timestamp,
-                           u_int64_t * packets, u_int64_t * bytes);
+                           unsigned int * timestamp
+#ifndef QCMAP
+                  ,u_int64_t * packets, u_int64_t * bytes
+#endif
+                  );
 
 /* return an (malloc'ed) array of "external" port for which there is
  * a port mapping. number is the size of the array */
diff --git a/netfilter/iptcrdr.c b/netfilter/iptcrdr.c
old mode 100644
new mode 100755
index fcea6e1..b3609e2
--- a/netfilter/iptcrdr.c
+++ b/netfilter/iptcrdr.c
@@ -4,7 +4,10 @@
  * (c) 2006-2011 Thomas Bernard
  * This software is subject to the conditions detailed
  * in the LICENCE file provided within the distribution */
+#include "../config.h"
 #include <stdio.h>
+#include "iptcrdr.h"
+#ifndef QCMAP
 #include <stdlib.h>
 #include <string.h>
 #include <syslog.h>
@@ -89,7 +92,7 @@ static int snprintip(char * dst, size_t size, uint32_t ip)
 	       "%u.%u.%u.%u", ip >> 24, (ip >> 16) & 0xff,
 	       (ip >> 8) & 0xff, ip & 0xff);
 }
-
+#endif
 /* netfilter cannot store redirection descriptions, so we use our
  * own structure to store them */
 struct rdr_desc {
@@ -199,6 +202,7 @@ get_redirect_desc_by_index(int index, unsigned short * eport, int * proto,
 }
 #endif
 
+#ifndef QCMAP
 /* add_redirect_rule2() */
 int
 add_redirect_rule2(const char * ifname,
@@ -1073,3 +1077,4 @@ list_redirect_rule(const char * ifname)
 	return 0;
 }
 #endif
+#endif
diff --git a/upnpredirect.c b/upnpredirect.c
old mode 100644
new mode 100755
index 8905d7e..848920e
--- a/upnpredirect.c
+++ b/upnpredirect.c
@@ -42,6 +42,9 @@
 #ifdef ENABLE_LEASEFILE
 #include <sys/stat.h>
 #endif
+#ifdef QCMAP
+#include "netfilter/iptcrdr.c"
+#endif
 
 /* from <inttypes.h> */
 #ifndef PRIu64
-- 
1.7.8.3

